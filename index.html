<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>NoLimits Boss Timer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background: radial-gradient(1200px 600px at top, #0f172a, #020617);
  color: #e5e7eb;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 20px;
}

h1 {
  margin-bottom: 4px;
}

.subtitle {
  color: #9ca3af;
  margin-bottom: 16px;
}

.banner {
  background: linear-gradient(90deg, #064e3b, #022c22);
  border-radius: 999px;
  padding: 10px 16px;
  margin-bottom: 18px;
  font-weight: 600;
}

.table-card {
  background: rgba(2,6,23,.85);
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 24px;
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
}

.table-scroll {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

table {
  width: 100%;
  min-width: 900px;
  border-collapse: collapse;
}

th, td {
  padding: 10px 12px;
  text-align: left;
  border-bottom: 1px solid rgba(255,255,255,.06);
  white-space: nowrap;
}

th {
  color: #9ca3af;
  font-size: 12px;
  letter-spacing: .08em;
}

.badge {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 700;
}

.badge.dynamic { background: #1e40af; }
.badge.fixed { background: #7c3aed; }

.countdown {
  font-weight: 700;
}

.section-title {
  margin: 12px 0;
  font-size: 18px;
}
</style>
</head>

<body>
<div class="container">
  <h1>NoLimits Boss Timer</h1>
  <div class="subtitle">Dynamic & fixed boss respawn tracking</div>

  <div id="banner" class="banner">Loadingâ€¦</div>

  <div class="section-title">Dynamic Respawns</div>
  <div class="table-card">
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Boss</th>
            <th>Respawn</th>
            <th>Time of Death</th>
            <th>Next Spawn</th>
            <th>Countdown</th>
          </tr>
        </thead>
        <tbody id="dynamic-body"></tbody>
      </table>
    </div>
  </div>

  <div class="section-title">Fixed / Guild Bosses</div>
  <div class="table-card">
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Boss</th>
            <th>Schedule</th>
            <th>Next Spawn</th>
            <th>Countdown</th>
          </tr>
        </thead>
        <tbody id="fixed-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API_URL = "PASTE_YOUR_APPS_SCRIPT_EXEC_URL_HERE";
const POLL_MS = 10000;

const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

function parseTime(str) {
  const [h,m] = str.split(":").map(Number);
  return { h, m };
}

function nextFixedDate(day, time) {
  const now = new Date();
  const targetDay = days.indexOf(day);
  if (targetDay < 0) return null;

  let d = new Date(now);
  d.setHours(time.h, time.m, 0, 0);

  const diff = (targetDay - d.getDay() + 7) % 7;
  if (diff === 0 && d <= now) d.setDate(d.getDate() + 7);
  else d.setDate(d.getDate() + diff);

  return d;
}

function formatCountdown(ms) {
  if (ms <= 0) return "00h 00m 00s";
  const s = Math.floor(ms/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const r = s%60;
  return `${h}h ${m.toString().padStart(2,"0")}m ${r.toString().padStart(2,"0")}s`;
}

async function load() {
  const res = await fetch(API_URL);
  const json = await res.json();
  const bosses = json.bosses || [];
  const now = new Date();

  const dynamic = [];
  const fixed = [];

  bosses.forEach(b => {
    if (b.respawn_type === "dynamic") dynamic.push(b);
    else fixed.push(b);
  });

  const dynBody = document.getElementById("dynamic-body");
  dynBody.innerHTML = "";

  let soonest = null;

  dynamic.forEach(b => {
    if (!b.last_death_iso || !b.respawn_hours) return;

    const death = new Date(b.last_death_iso);
    const next = new Date(death.getTime() + b.respawn_hours*3600000);
    const cd = next - now;

    if (!soonest || next < soonest) soonest = next;

    dynBody.innerHTML += `
      <tr>
        <td>${b.boss_name}</td>
        <td><span class="badge dynamic">${b.respawn_hours}h</span></td>
        <td>${death.toLocaleString()}</td>
        <td>${next.toLocaleString()}</td>
        <td class="countdown">${formatCountdown(cd)}</td>
      </tr>`;
  });

  const fixBody = document.getElementById("fixed-body");
  fixBody.innerHTML = "";

  fixed.forEach(b => {
    const times = [];

    if (b.fixed_day_1 && b.fixed_time_1_24h) {
      times.push(nextFixedDate(b.fixed_day_1, parseTime(b.fixed_time_1_24h)));
    }
    if (b.fixed_day_2 && b.fixed_time_2_24h) {
      times.push(nextFixedDate(b.fixed_day_2, parseTime(b.fixed_time_2_24h)));
    }

    const next = times.filter(Boolean).sort((a,b)=>a-b)[0];
    if (!next) return;

    const cd = next - now;
    if (!soonest || next < soonest) soonest = next;

    fixBody.innerHTML += `
      <tr>
        <td>${b.boss_name} <span class="badge fixed">Guild</span></td>
        <td>${[b.fixed_day_1,b.fixed_time_1_24h,b.fixed_day_2,b.fixed_time_2_24h].filter(Boolean).join(", ")}</td>
        <td>${next.toLocaleString()}</td>
        <td class="countdown">${formatCountdown(cd)}</td>
      </tr>`;
  });

  document.getElementById("banner").textContent =
    soonest
      ? `Next spawn at ${soonest.toLocaleString()}`
      : "No upcoming spawns";
}

load();
setInterval(load, POLL_MS);
</script>
</body>
</html>
